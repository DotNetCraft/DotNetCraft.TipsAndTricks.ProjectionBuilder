name: Auto tag
on:
  push:
    branches:
      - '**'

jobs:
  build:
    name: Create Tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Create Tag
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          if [[ "$BRANCH_NAME" == "main" ]]; then
            VERSION="1.0.0"
          else
            VERSION="1.0.0-prerelease"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: ðŸ·ï¸ Create/update tag
        uses: actions/github-script@v7
        with:
          script: |
            const version = process.env.VERSION
            let versionParts = version.split('.')
            versionParts[2] = parseInt(versionParts[2]) + 1
            const newVersion = versionParts.join('.')
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/v' + newVersion,
              sha: context.sha
            }).catch(err => {
              if (err.status !== 422) throw err;
              github.rest.git.updateRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'tags/v' + newVersion,
                sha: context.sha
              });
            })